{
  "name": "Email to Ticket - IMAP",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 1 Minute",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "mailbox": "INBOX",
        "postProcessAction": "mark",
        "options": {}
      },
      "id": "get-emails-imap",
      "name": "Get Unread Emails (IMAP)",
      "type": "n8n-nodes-base.emailReadImap",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "imap": {
          "id": "office365-imap",
          "name": "Office 365 IMAP"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-3.5-turbo\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Classify this email as: SUPPORT_REQUEST, VENDOR_EMAIL, or UNCERTAIN. Respond with JSON: {\\\"classification\\\": \\\"...\\\", \\\"confidence\\\": 0-100, \\\"reason\\\": \\\"...\\\", \\\"priority\\\": \\\"low|normal|high\\\"}\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"From: {{ $json.from.value[0].address }}\\nSubject: {{ $json.subject }}\\nBody: {{ $json.text }}\"\n    }\n  ],\n  \"temperature\": 0.3\n}",
        "options": {}
      },
      "id": "classify-email",
      "name": "AI Classify Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "openai-header-auth",
          "name": "OpenAI Header Auth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ JSON.parse($json.choices[0].message.content).classification }}",
              "operation": "equals",
              "value2": "SUPPORT_REQUEST"
            }
          ]
        }
      },
      "id": "check-classification",
      "name": "Is Support Request?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:3000/api/tickets",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"{{ $('Get Unread Emails (IMAP)').item.json.subject }}\",\n  \"description\": \"{{ $('Get Unread Emails (IMAP)').item.json.text }}\",\n  \"requesterEmail\": \"{{ $('Get Unread Emails (IMAP)').item.json.from.value[0].address }}\",\n  \"priority\": \"{{ JSON.parse($('AI Classify Email').item.json.choices[0].message.content).priority || 'NORMAL' }}\",\n  \"source\": \"email\"\n}",
        "options": {}
      },
      "id": "create-ticket",
      "name": "Create Ticket",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 200],
      "credentials": {
        "httpBasicAuth": {
          "id": "helpdesk-api-auth",
          "name": "helpdesk-api-auth"
        }
      }
    }
  ],
  "connections": {
    "Every 1 Minute": {
      "main": [
        [
          {
            "node": "Get Unread Emails (IMAP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unread Emails (IMAP)": {
      "main": [
        [
          {
            "node": "AI Classify Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Classify Email": {
      "main": [
        [
          {
            "node": "Is Support Request?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Support Request?": {
      "main": [
        [
          {
            "node": "Create Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
